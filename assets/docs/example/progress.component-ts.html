<span class="hljs-keyword">import</span> { Observable, Subscription } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/Rx'</span>;
<span class="hljs-keyword">import</span> { Component, ViewEncapsulation, OnDestroy } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component</span>({
    selector: <span class="hljs-string">'example-progress'</span>,
    templateUrl: <span class="hljs-string">'./progress.component.html'</span>,
    styleUrls: [<span class="hljs-string">'./progress.component.scss'</span>],
    encapsulation: ViewEncapsulation.None
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DemoProgressComponent <span class="hljs-keyword">implements</span> OnDestroy {

    uploading: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
    res: <span class="hljs-built_in">any</span> = {
        g1: { value: <span class="hljs-number">0</span>, doing: <span class="hljs-literal">false</span> },
        g2: { value: <span class="hljs-number">10</span>, doing: <span class="hljs-literal">false</span> },
        g3: { value: <span class="hljs-number">50</span>, doing: <span class="hljs-literal">false</span> }
    };
    subscription: Subscription = <span class="hljs-literal">null</span>;

    onUpload() {
        <span class="hljs-keyword">this</span>.onCancelAll();
        <span class="hljs-keyword">this</span>.uploading = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.res = {
            g1: { value: <span class="hljs-number">0</span>, doing: <span class="hljs-literal">true</span> },
            g2: { value: <span class="hljs-number">10</span>, doing: <span class="hljs-literal">true</span> },
            g3: { value: <span class="hljs-number">50</span>, doing: <span class="hljs-literal">true</span> }
        };

        <span class="hljs-keyword">this</span>.subscription = Observable.timer(<span class="hljs-number">0</span>, <span class="hljs-number">40</span>).subscribe(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">let</span> endCount = <span class="hljs-number">0</span>;
            <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.res).forEach(<span class="hljs-function">(<span class="hljs-params">key:<span class="hljs-built_in">string</span></span>) =&gt;</span> {
                <span class="hljs-keyword">let</span> item = <span class="hljs-keyword">this</span>.res[key];
                <span class="hljs-keyword">if</span> (!item.doing) {
                    ++endCount;
                    <span class="hljs-keyword">return</span> ;
                }
                ++item.value;
                <span class="hljs-keyword">if</span> (item.value &gt;= <span class="hljs-number">100</span>) item.doing = <span class="hljs-literal">false</span>;
            });
            <span class="hljs-keyword">if</span> (endCount === <span class="hljs-number">3</span>) <span class="hljs-keyword">this</span>.onCancelAll();
        });
    }

    onCancelAll() {
        <span class="hljs-keyword">this</span>.uploading = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.subscription) <span class="hljs-keyword">this</span>.subscription.unsubscribe();
    }

    onCancel(<span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>) {
        <span class="hljs-keyword">this</span>.res[<span class="hljs-keyword">type</span>].doing = <span class="hljs-literal">false</span>;
    }

    ngOnDestroy(): <span class="hljs-built_in">void</span> {
        <span class="hljs-keyword">this</span>.onCancelAll();
    }

} 
